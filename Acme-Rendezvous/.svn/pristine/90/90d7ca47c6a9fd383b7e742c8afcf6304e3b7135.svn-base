
package services.form;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;

import security.UserAccount;
import security.UserAccountService;
import services.ActorService;
import services.AdministratorService;
import services.UserService;
import domain.Actor;
import domain.Administrator;
import domain.User;
import domain.form.ActorForm;

@Service
@Transactional
public class ActorFormService {

	// Managed repository -----------------------------------------------------

	// Supporting services ----------------------------------------------------

	@Autowired
	private ActorService			actorService;

	@Autowired
	private UserAccountService		userAccountService;

	@Autowired
	private AdministratorService	administratorService;

	@Autowired
	private UserService				userService;


	// Constructors -----------------------------------------------------------

	public ActorFormService() {
		super();
	}

	public ActorForm create() {
		ActorForm result;

		result = new ActorForm();

		return result;
	}

	public ActorForm createFromActor() {
		ActorForm result;
		final Actor actor = this.actorService.findByPrincipal();
		final SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm");
		final String birthDate = sdf.format(actor.getBirthDate());

		result = new ActorForm();
		result.setName(actor.getName());
		result.setSurname(actor.getSurname());
		result.setEmail(actor.getEmail());
		result.setAddress(actor.getAddress());
		result.setPhone(actor.getPhone());
		result.setBirthDate(birthDate);
		result.setUsername(actor.getUserAccount().getUsername());

		return result;
	}

	public void reconstruct(final ActorForm actorForm, final String authority) {
		UserAccount userAccount;
		userAccount = this.userAccountService.findByUsername(actorForm.getUsername());

		if (userAccount == null)
			this.saveFromCreate(actorForm, authority);
		else
			this.saveFromEdit(actorForm, authority);
	}

	public Actor saveFromCreate(final ActorForm actorForm, final String authority) {
		Assert.notNull(actorForm, "message.error.actorForm.null");
		Assert.isTrue(actorForm.getPassword().equals(actorForm.getRepeatedPassword()), "message.error.actorForm.password.mismatch");
		Assert.isTrue(actorForm.getAcceptTerms(), "message.error.actorForm.acceptTerms.false");

		if (authority.equals("ADMIN")) {
			final Administrator result;
			final Administrator administrator;
			UserAccount userAccount;

			userAccount = this.userAccountService.createComplete(actorForm.getUsername(), actorForm.getPassword(), authority);
			administrator = this.administratorService.create();

			final SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm");

			administrator.setName(actorForm.getName());
			administrator.setSurname(actorForm.getSurname());
			administrator.setEmail(actorForm.getEmail());
			administrator.setAddress(actorForm.getAddress());
			administrator.setPhone(actorForm.getPhone());
			try {
				final Date birthDate = sdf.parse(actorForm.getBirthDate());
				administrator.setBirthDate(birthDate);
			} catch (final ParseException parseException) {
				Assert.isNull(parseException.getMessage(), "message.error.actorForm.birthDate.format");
			}
			administrator.setUserAccount(userAccount);

			result = this.administratorService.saveFromCreate(administrator);

			return result;
		} else if (authority.equals("USER")) {
			final User result;
			final User user;
			final UserAccount userAccount;

			userAccount = this.userAccountService.createComplete(actorForm.getUsername(), actorForm.getPassword(), "USER");
			user = this.userService.create();

			final SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm");

			user.setName(actorForm.getName());
			user.setSurname(actorForm.getSurname());
			user.setEmail(actorForm.getEmail());
			user.setAddress(actorForm.getAddress());
			user.setPhone(actorForm.getPhone());

			try {
				final Date birthDate = sdf.parse(actorForm.getBirthDate());
				user.setBirthDate(birthDate);
			} catch (final ParseException parseException) {
				Assert.isNull(parseException.getMessage(), "message.error.actorForm.birthDate.format");
			}

			user.setUserAccount(userAccount);

			result = this.userService.saveFromCreate(user);

			return result;

		}

		return null;
	}
	public Actor saveFromEdit(final ActorForm actorForm, final String authority) {
		Assert.notNull(actorForm);
		Assert.isTrue(actorForm.getPassword().equals(actorForm.getRepeatedPassword()), "message.error.actorForm.password.mismatch");
		Assert.isTrue(actorForm.getAcceptTerms(), "message.error.actorForm.acceptTerms.false");

		if (authority.equals("ADMIN")) {
			final Actor principal = this.actorService.findByPrincipal();
			UserAccount userAccount;

			userAccount = principal.getUserAccount();
			userAccount.setPassword(actorForm.getPassword());

			final Administrator result;
			final Administrator administrator;
			final SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm");

			administrator = this.administratorService.findByPrincipal();

			administrator.setName(actorForm.getName());
			administrator.setSurname(actorForm.getSurname());
			administrator.setEmail(actorForm.getEmail());
			administrator.setAddress(actorForm.getAddress());
			administrator.setPhone(actorForm.getPhone());
			try {
				final Date birthDate = sdf.parse(actorForm.getBirthDate());
				administrator.setBirthDate(birthDate);
			} catch (final ParseException parseException) {
				Assert.isNull(parseException.getMessage(), "message.error.actorForm.birthDate.format");
			}
			administrator.setUserAccount(userAccount);

			result = this.administratorService.saveFromEdit(administrator);

			return result;
		} else if (authority.equals("USER")) {
			final Actor principal = this.actorService.findByPrincipal();
			UserAccount userAccount;

			userAccount = principal.getUserAccount();
			userAccount.setPassword(actorForm.getPassword());

			final User result;
			final User user;
			final SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm");

			user = this.userService.findByPrincipal();

			user.setName(actorForm.getName());
			user.setSurname(actorForm.getSurname());
			user.setEmail(actorForm.getEmail());
			user.setAddress(actorForm.getAddress());
			user.setPhone(actorForm.getPhone());
			try {
				final Date birthDate = sdf.parse(actorForm.getBirthDate());
				user.setBirthDate(birthDate);
			} catch (final ParseException parseException) {
				Assert.isNull(parseException.getMessage(), "message.error.actorForm.birthDate.format");
			}
			user.setUserAccount(userAccount);

			result = this.userService.saveFromEdit(user);

			return result;
		}

		return null;
	}

}
